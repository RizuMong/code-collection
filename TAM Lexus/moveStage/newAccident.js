var payload = {
  "body": {
            "additional_fields": [
                {
                    "id": 12234035,
                    "name": "no__hp",
                    "value": null,
                    "value_name": null
                },
                {
                    "id": 13473277,
                    "name": "location",
                    "value": null,
                    "value_name": null
                },
                {
                    "id": 13473278,
                    "name": "destination",
                    "value": null,
                    "value_name": null
                },
                {
                    "id": 13567999,
                    "name": "email_dealer",
                    "value": null,
                    "value_name": null
                },
                {
                    "id": 13562284,
                    "name": "customer_public_id",
                    "value": null,
                    "value_name": null
                },
                {
                    "id": 14171324,
                    "name": "nama",
                    "value": null,
                    "value_name": null
                },
                {
                    "id": 13806663,
                    "name": "temporary_customer_id",
                    "value": null,
                    "value_name": null
                },
                {
                    "id": 13560722,
                    "name": "vin",
                    "value": "X3JHT14561271FR02",
                    "value_name": "X3JHT14561271FR02"
                },
                {
                    "id": 14181086,
                    "name": "plate_no",
                    "value": null,
                    "value_name": null
                },
                {
                    "id": 14171238,
                    "name": "service_date",
                    "value": null,
                    "value_name": null
                },
                {
                    "id": 14168845,
                    "name": "ldms_wo_id",
                    "value": null,
                    "value_name": null
                },
                {
                    "id": 13562529,
                    "name": "ldms_customer_id",
                    "value": "00",
                    "value_name": "00"
                },
                {
                    "id": 14589501,
                    "name": "ldms_reservation_id",
                    "value": null,
                    "value_name": null
                },
                {
                    "id": 14439961,
                    "name": "ldms_vehicle_id",
                    "value": "X3JHT14561271FR02",
                    "value_name": "X3JHT14561271FR02"
                },
                {
                    "id": 13561419,
                    "name": "variant",
                    "value": null,
                    "value_name": null
                },
                {
                    "id": 14181431,
                    "name": "description",
                    "value": null,
                    "value_name": null
                },
                {
                    "id": 14171237,
                    "name": "service_type",
                    "value": null,
                    "value_name": null
                },
                {
                    "id": 13560634,
                    "name": "phone_number",
                    "value": "k5iFW0IKFzre",
                    "value_name": "k5iFW0IKFzre"
                },
                {
                    "id": 13560721,
                    "name": "domisili",
                    "value": null,
                    "value_name": null
                },
                {
                    "id": 13473449,
                    "name": "complaint_type__sales",
                    "value": null,
                    "value_name": null
                },
                {
                    "id": 13560808,
                    "name": "subject_type",
                    "value": "3837138",
                    "value_name": "Sales"
                },
                {
                    "id": 13561075,
                    "name": "category",
                    "value": "3837206",
                    "value_name": "Question"
                },
                {
                    "id": 13561331,
                    "name": "category_complaint",
                    "value": null,
                    "value_name": null
                },
                {
                    "id": 13561332,
                    "name": "sub_category",
                    "value": "3837277",
                    "value_name": "Question"
                },
                {
                    "id": 13561422,
                    "name": "customer_source",
                    "value": null,
                    "value_name": null
                },
                {
                    "id": 13562019,
                    "name": "channel",
                    "value": null,
                    "value_name": null
                },
                {
                    "id": 13562105,
                    "name": "urgency_level",
                    "value": null,
                    "value_name": null
                },
                {
                    "id": 13562462,
                    "name": "concierge_key",
                    "value": "",
                    "value_name": ""
                },
                {
                    "id": 13562193,
                    "name": "interaction_type",
                    "value": null,
                    "value_name": null
                },
                {
                    "id": 13562194,
                    "name": "interface_ticket_qontak",
                    "value": "3837580",
                    "value_name": "True"
                },
                {
                    "id": 13562300,
                    "name": "status_dealer_service",
                    "value": null,
                    "value_name": null
                },
                {
                    "id": 13562374,
                    "name": "status_lmcs",
                    "value": null,
                    "value_name": null
                },
                {
                    "id": 13562375,
                    "name": "schedule",
                    "value": null,
                    "value_name": null
                },
                {
                    "id": 14620818,
                    "name": "schedule_confirmed",
                    "value": null,
                    "value_name": null
                },
                {
                    "id": 13562463,
                    "name": "message",
                    "value": "",
                    "value_name": ""
                },
                {
                    "id": 13562464,
                    "name": "l_reach_location",
                    "value": "",
                    "value_name": ""
                },
                {
                    "id": 13562479,
                    "name": "coordinate",
                    "value": "",
                    "value_name": ""
                },
                {
                    "id": 13562723,
                    "name": "url_l_reach",
                    "value": "",
                    "value_name": ""
                },
                {
                    "id": 13562724,
                    "name": "dealer_booking_service_id",
                    "value": null,
                    "value_name": null
                },
                {
                    "id": 13562725,
                    "name": "lmcs_id",
                    "value": null,
                    "value_name": null
                },
                {
                    "id": 13616060,
                    "name": "dealer_req_key",
                    "value": null,
                    "value_name": null
                },
                {
                    "id": 13616061,
                    "name": "dealer_name",
                    "value": null,
                    "value_name": null
                },
                {
                    "id": 13616062,
                    "name": "food_beverages",
                    "value": null,
                    "value_name": null
                },
                {
                    "id": 13669344,
                    "name": "service_type_l_reach",
                    "value": null,
                    "value_name": null
                },
                {
                    "id": 14184596,
                    "name": "mtoyota_phone_number",
                    "value": null,
                    "value_name": null
                },
                {
                    "id": 14184597,
                    "name": "cc_phone_number",
                    "value": null,
                    "value_name": null
                },
                {
                    "id": 14184598,
                    "name": "cc_subscription_id",
                    "value": "240700007RMDI=",
                    "value_name": "240700007RMDI="
                },
                {
                    "id": 14428309,
                    "name": "dealer_code",
                    "value": null,
                    "value_name": null
                },
                {
                    "id": 14436972,
                    "name": "status_ticket_qontak",
                    "value": null,
                    "value_name": null
                },
                {
                    "id": 14557520,
                    "name": "call_center_telematics_url",
                    "value": null,
                    "value_name": null
                },
                {
                    "id": 14451134,
                    "name": "is_from_lexus_reach",
                    "value": null,
                    "value_name": null
                },
                {
                    "id": 14451135,
                    "name": "is_telematics_emergency",
                    "value": null,
                    "value_name": null
                },
                {
                    "id": 14451232,
                    "name": "is_telematics_renewal",
                    "value": null,
                    "value_name": null
                },
                {
                    "id": 14451329,
                    "name": "is_telematics_disconnected",
                    "value": null,
                    "value_name": null
                },
                {
                    "id": 14536533,
                    "name": "remarks",
                    "value": "Test",
                    "value_name": "Test"
                },
                {
                    "id": 14646435,
                    "name": "status",
                    "value": "4253699",
                    "value_name": "Cancelled"
                }
            ],
            "channel_integration_room_id": null,
            "closed_date": null,
            "created_at": "2024-09-13T10:00:42.792+07:00",
            "creator_id": 185776,
            "creator_name": "Rizky Pambudi -",
            "crm_company_id": null,
            "crm_company_name": null,
            "crm_lead_ids": [],
            "crm_lead_name": [],
            "crm_lost_reason_id": null,
            "crm_lost_reason_name": null,
            "crm_pipeline_id": 150181,
            "crm_pipeline_name": "Accident",
            "crm_priority_id": null,
            "crm_priority_name": null,
            "crm_source_id": null,
            "crm_source_name": null,
            "crm_stage_id": 1043507,
            "crm_stage_name": "Closed",
            "currency": "IDR",
            "expired_date": null,
            "external_company_id": 836993,
            "id": 55804408,
            "name": "Mick Schumacher",
            "product_association_ids": [],
            "product_association_name": [],
            "product_association_price": [],
            "product_association_quantity": [],
            "product_association_total_price": [],
            "size": "0.0",
            "slug": "c5bbcb5c-cc21-42cd-8a4d-da6064b31291",
            "start_date": null,
            "updated_at": "2024-09-13T10:56:11.357+07:00"
        }
};

var getDataExist = {
  "company_id": 28001,
  "created_at": 1726196659617,
  "created_by": 0,
  "id": "55804408",
  "pipeline_name": "Accident",
  "stage_name": "Closed",
  "ticket_qontak_id": "55804408",
  "updated_at": 1726196767858,
  "updated_by": 0
}

var payloadAPIConfirm = {
  "unique_ticket_id": payload.body.id.toString(),
  "status": "confirmed",
  "pipeline_id": payload.body.crm_pipeline_id.toString(),
  "pipeline_name": payload.body.crm_pipeline_name,
  "stage_id": payload.body.crm_stage_id.toString(),
  "stage_name": payload.body.crm_stage_name,
};

var payloadAPICancelled = {
  "unique_ticket_id": payload.body.id.toString(),
  "status": "cancelled",
};

var hitStatus = "--";

payload.body.additional_fields.forEach(function (item) {
  if (item.name === "variant" && item.value) {
      var type = item.value.toLowerCase();

      switch (type) {
          case "general":
              payloadAPIConfirm.type = 1;
              break;
          case "lfast non-technical":
              payloadAPIConfirm.type = 2;
              break;
          case "lfast technical":
              payloadAPIConfirm.type = 3;
              break;
          default:
              payloadAPIConfirm.type = null;
      }
  }

  if (item.name === "dealer_code" && item.value) {
      var dealerName = item.value.toLowerCase();

      switch (dealerName) {
          case "1. menteng":
              payloadAPIConfirm.dealer_code = 1;
              break;
          case "2. mampang":
              payloadAPIConfirm.dealer_code = 2;
              break;
          case "3. pluit":
              payloadAPIConfirm.dealer_code = 3;
              break;
          case "4. other":
              payloadAPIConfirm.dealer_code = 4;
              break;
          default:
              payloadAPIConfirm.dealer_code = null;
      }
  };

  if (item.name === "ldms_vehicle_id" && item.value != null) {
      payloadAPIConfirm.ldms_vehicle_id = item.value;
  };

  if (item.name === "description" && item.value != null) {
      payloadAPIConfirm.description = item.value;
      payloadAPICancelled.description = item.value;
  }

  if (item.name === "status" && item.value != null && item.value != "") {
    hitStatus = item.value_name
  }
});

console.log(hitStatus);

var isUpdateConfirmed = false;

if (Object.keys(getDataExist).length == 0 && payload.body.crm_stage_name == "On Progress") {
  isUpdateConfirmed = true;
};

// Case Confirmed
if (payload.body.crm_stage_name == "On Progress" || isUpdateConfirmed) {
  var hitAPILexus = _hitFunction("func_hit_api_lexus", {
      "endpoint": "/qontak/concierge/status",
      "payload": payloadAPIConfirm,
      "ticket_qontak_id": payload.body.id,
      "deal_name": payload.body.name
  });
};

var isUpdateCompleted = false;

if (Object.keys(getDataExist).length == 0 && hitStatus == "Closed") {
  isUpdateCompleted = true;
};

// Case Completed
if (hitStatus == "Closed" || isUpdateCompleted) {
  var payloadAPICompleted = {
      "unique_ticket_id": payload.body.id.toString(),
      "status": "completed",
  };

  // if (payloadAPIConfirm.type == 3) {
  //     _log("Only status = confirmed, with type = 'General' / 'LFast non technical' can be updated to completed");
  //     _stopAutomation();
  // };

  // var hitAPILexus = _hitFunction("func_hit_api_lexus", {
  //     "endpoint": "/qontak/concierge/status",
  //     "payload": payloadAPICompleted,
  //     "ticket_qontak_id": payload.body.id,
  //     "deal_name": payload.body.name
  // });
};

var isUpdateCancelled = false;

if (Object.keys(getDataExist).length == 0 && hitStatus == "Cancelled") {
  isUpdateCancelled = true;
};

// Case Cancelled
if (hitStatus == "Cancelled" || isUpdateCancelled) {
  var hitAPILexus = _hitFunction("func_hit_api_lexus", {
      "endpoint": "/qontak/concierge/status",
      "payload": payloadAPICancelled,
      "ticket_qontak_id": payload.body.id,
      "deal_name": payload.body.name
  });
}