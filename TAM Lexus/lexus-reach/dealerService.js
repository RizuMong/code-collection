var req = {
  body: {
    additional_fields: [
      {
        id: 13560722,
        name: "vin",
        value: "X3JHT14561271FR02",
        value_name: "X3JHT14561271FR02",
      },
      {
        id: 14181086,
        name: "plate_no",
        value: null,
        value_name: null,
      },
      {
        id: 14171238,
        name: "service_date",
        value: null,
        value_name: null,
      },
      {
        id: 14168845,
        name: "ldms_wo_id",
        value: null,
        value_name: null,
      },
      {
        id: 13561419,
        name: "variant",
        value: null,
        value_name: null,
      },
      {
        "id": 14181431,
        "name": "description",
        "value": "123",
        "value_name": "123"
    },
      {
        id: 13562529,
        name: "ldms_customer_id",
        value: "23-CP-0000048",
        value_name: "23-CP-0000048",
      },
      {
        id: 14171237,
        name: "service_type",
        value: "4070779",
        value_name: "General Service (GR)",
      },
      {
        id: 13560634,
        name: "phone_number",
        value: "k5iFW0IKFzre",
        value_name: "k5iFW0IKFzre",
      },
      {
        id: 13560721,
        name: "domisili",
        value: null,
        value_name: null,
      },
      {
        id: 13473449,
        name: "complaint_type__sales",
        value: null,
        value_name: null,
      },
      {
        id: 13560808,
        name: "subject_type",
        value: "3837161",
        value_name: "After Sales",
      },
      {
        id: 13561075,
        name: "category",
        value: "3837206",
        value_name: "Question",
      },
      {
        id: 13561331,
        name: "category_complaint",
        value: null,
        value_name: null,
      },
      {
        id: 13561332,
        name: "sub_category",
        value: "3837277",
        value_name: "Question",
      },
      {
        id: 13561422,
        name: "customer_source",
        value: null,
        value_name: null,
      },
      {
        id: 13562019,
        name: "channel",
        value: null,
        value_name: null,
      },
      {
        id: 13562105,
        name: "urgency_level",
        value: null,
        value_name: null,
      },
      {
        id: 13562193,
        name: "interaction_type",
        value: null,
        value_name: null,
      },
      {
        id: 13562194,
        name: "interface_ticket_qontak",
        value: "3837580",
        value_name: "True",
      },
      {
        id: 13562283,
        name: "status_concierge",
        value: null,
        value_name: null,
      },
      {
        id: 13562300,
        name: "status_dealer_service",
        value: null,
        value_name: null,
      },
      {
        id: 13562374,
        name: "status_lmcs",
        value: null,
        value_name: null,
      },
      {
        id: 13562375,
        name: "schedule",
        value: null,
        value_name: null,
      },
      {
        id: 13562462,
        name: "concierge_key",
        value: "CRG/20240905/0932",
        value_name: "CRG/20240905/0932",
      },
      {
        id: 13562463,
        name: "message",
        value: null,
        value_name: null,
      },
      {
        id: 13562464,
        name: "l_reach_location",
        value:
          "KVzsoJu u3x4fe sH.dz WwMUXF qtWzZdt3z fRDaEjT ZOP2rMxi hZ4u tdgxhTi 8s9am49",
        value_name:
          "KVzsoJu u3x4fe sH.dz WwMUXF qtWzZdt3z fRDaEjT ZOP2rMxi hZ4u tdgxhTi 8s9am49",
      },
      {
        id: 13562479,
        name: "coordinate",
        value: "[-6.2663404,106.8256214]",
        value_name: "[-6.2663404,106.8256214]",
      },
      {
        id: 13562723,
        name: "url_l_reach",
        value: "https://cms.lexus.neo-fusion.com/ServiceConciergeRequest/932",
        value_name:
          "https://cms.lexus.neo-fusion.com/ServiceConciergeRequest/932",
      },
      {
        id: 13562724,
        name: "dealer_booking_service_id",
        value: null,
        value_name: null,
      },
      {
        id: 13562725,
        name: "lmcs_id",
        value: null,
        value_name: null,
      },
      {
        id: 13616060,
        name: "dealer_req_key",
        value: null,
        value_name: null,
      },
      {
        id: 13616061,
        name: "dealer_name",
        value: null,
        value_name: null,
      },
      {
        id: 13616062,
        name: "food_beverages",
        value: null,
        value_name: null,
      },
      {
        id: 13669344,
        name: "service_type_l_reach",
        value: null,
        value_name: null,
      },
      {
        id: 14184596,
        name: "mtoyota_phone_number",
        value: null,
        value_name: null,
      },
      {
        id: 14184597,
        name: "cc_phone_number",
        value: null,
        value_name: null,
      },
      {
        id: 14184598,
        name: "cc_subscription_id",
        value: null,
        value_name: null,
      },
      {
        id: 14428309,
        name: "dealer_code",
        value: null,
        value_name: null,
      },
      {
        id: 14436972,
        name: "status_ticket_qontak",
        value: null,
        value_name: null,
      },
      {
        id: 14439961,
        name: "ldms_vehicle_id",
        value: null,
        value_name: null,
      },
      {
        id: 14451134,
        name: "is_from_lexus_reach",
        value: null,
        value_name: null,
      },
      {
        id: 14451135,
        name: "is_telematics_emergency",
        value: null,
        value_name: null,
      },
      {
        id: 14451232,
        name: "is_telematics_renewal",
        value: null,
        value_name: null,
      },
      {
        id: 14451329,
        name: "is_telematics_disconnected",
        value: null,
        value_name: null,
      },
      {
        id: 14536533,
        name: "remarks",
        value: "test",
        value_name: "test",
      },
    ],
    channel_integration_room_id: null,
    closed_date: null,
    created_at: "2024-09-05T12:39:51.522+07:00",
    creator_id: 185776,
    creator_name: "Rizky Pambudi -",
    crm_company_id: null,
    crm_company_name: null,
    crm_lead_ids: [],
    crm_lead_name: [],
    crm_lost_reason_id: null,
    crm_lost_reason_name: null,
    crm_pipeline_id: 168201,
    crm_pipeline_name: "Concierge - General & LFast Non Technical",
    crm_priority_id: null,
    crm_priority_name: null,
    crm_source_id: null,
    crm_source_name: null,
    crm_stage_id: 1043428,
    crm_stage_name: "Completed",
    currency: "IDR",
    expired_date: null,
    external_company_id: 836993,
    id: 55530416,
    name: "Mick Schumacher",
    product_association_ids: [],
    product_association_name: [],
    product_association_price: [],
    product_association_quantity: [],
    product_association_total_price: [],
    size: "0.0",
    slug: "b591ed86-05cc-44ee-b819-5a25d316191a",
    start_date: null,
    updated_at: "2024-09-05T14:46:16.201+07:00",
  },
};

var statusMapping = {
  "1. Menteng": 1,
  "2. Mampang": 2,
  "3. Pluit": 3,
  "4. Other": 3,
};

var payloadAPIConfirm = {
  unique_ticket_id: req.body.id.toString(),
  status: "confirmed",
  pipeline_id: req.body.crm_pipeline_id.toString(),
  pipeline_name: req.body.crm_pipeline_name,
  stage_id: req.body.crm_stage_id.toString(),
  stage_name: req.body.crm_stage_name,
};

var payloadAPICancelled = {
  unique_ticket_id: req.body.id.toString(),
  status: "cancelled",
};

var payloadAPICompleted = {
  unique_ticket_id: req.body.id.toString(),
  status: "completed",
};

req.body.additional_fields.forEach(function (item) {
  if (item.name == "variant" && item.value != null) {
    if (item.value_name.toLowerCase() == "general") {
      payloadAPIConfirm.type = 1;
    } else if (item.value_name.toLowerCase() == "lfast non-technical") {
      payloadAPIConfirm.type = 2;
    } else if (item.value_name.toLowerCase() == "lfast technical") {
      payloadAPIConfirm.type = 3;
    }
  }

  if (item.name == "dealer_code" && item.value != null) {
    if (statusMapping.hasOwnProperty(item.value_name)) {
      payloadAPIConfirm.dealer_code = statusMapping[item.value_name];
    }
  }

  if (item.name == "ldms_vehicle_id" && item.value != null) {
    payloadAPIConfirm.ldms_vehicle_id = item.value;
  }

  if (item.name == "description" && item.value != null) {
    payloadAPIConfirm.description = item.value;
    payloadAPICancelled.description = item.value;
  }
});

console.log(payloadAPIConfirm);
console.log(payloadAPICancelled);
console.log(payloadAPICompleted);

// Hit API Lexus
if (req.body.crm_stage_name == "Confirmed") {
  if (!payloadAPIConfirm.dealer_code && payloadAPIConfirm.type === 3) {
    console.log("penjagaan type(variant) = 3 / LFast technical maka dealer code wajib ada")
    // _stopAutomation();
  }
  // var hitAPILexus = _hitFunction("func_hit_api_lexus", {
  //   endpoint: "/qontak/concierge/status",
  //   payload: payloadAPIConfirm,
  //   ticket_qontak_id: req.body.id,
  //   deal_name: req.body.name,
  // });
};

if (req.body.crm_stage_name == "Cancelled") {
  // var hitAPILexus = _hitFunction("func_hit_api_lexus", {
  //   endpoint: "/qontak/concierge/status",
  //   payload: payloadAPICancelled,
  //   ticket_qontak_id: req.body.id,
  //   deal_name: req.body.name,
  // });
};

if (req.body.crm_stage_name == "Completed") {
  if (payloadAPIConfirm.type === 3) {
    console.log("Only status = confirmed, with type = 'General' / 'LFast non technical' can be updated to completed")
    // _stopAutomation();
  }

  // var hitAPILexus = _hitFunction("func_hit_api_lexus", {
  //   endpoint: "/qontak/concierge/status",
  //   payload: payloadAPICompleted,
  //   ticket_qontak_id: req.body.id,
  //   deal_name: req.body.name,
  // });
};
