var payload = {
  "counterLocket": 5,
  "dataParameter": {
      "column_type": "Cashless",
      "counterLocket": 5,
      "generateTime": 1727274985027,
      "idLocket": "Zc8YxyRHg",
      "idParameter": "81bzxsRHRz",
      "parameterCreate": {
          "_id": "66f41fe98e441d23a8f1181d",
          "awb_date_end": 1727197200000,
          "awb_date_start": 1725123600000,
          "awb_number": [],
          "branch_id_multi": [
              {
                  "id": "AMI",
                  "name": "AMI"
              },
              {
                  "id": "AMQ",
                  "name": "AMQ"
              },
              {
                  "id": "BDJ",
                  "name": "BDJ"
              },
              {
                  "id": "BDO",
                  "name": "BDO"
              },
              {
                  "id": "BKI",
                  "name": "BKI"
              },
              {
                  "id": "BKS",
                  "name": "BKS"
              },
              {
                  "id": "BOO",
                  "name": "BOO"
              },
              {
                  "id": "BPN",
                  "name": "BPN"
              },
              {
                  "id": "BTG",
                  "name": "BTG"
              },
              {
                  "id": "BTH",
                  "name": "BTH"
              },
              {
                  "id": "BTJ",
                  "name": "BTJ"
              },
              {
                  "id": "CBN",
                  "name": "CBN"
              },
              {
                  "id": "CGK",
                  "name": "CGK"
              },
              {
                  "id": "CKR",
                  "name": "CKR"
              },
              {
                  "id": "CLG",
                  "name": "CLG"
              },
              {
                  "id": "CXP",
                  "name": "CXP"
              },
              {
                  "id": "DJB",
                  "name": "DJB"
              },
              {
                  "id": "DJJ",
                  "name": "DJJ"
              },
              {
                  "id": "DPK",
                  "name": "DPK"
              },
              {
                  "id": "DPS",
                  "name": "DPS"
              },
              {
                  "id": "DTB",
                  "name": "DTB"
              },
              {
                  "id": "GTO",
                  "name": "GTO"
              },
              {
                  "id": "JBR",
                  "name": "JBR"
              },
              {
                  "id": "JOG",
                  "name": "JOG"
              },
              {
                  "id": "KDI",
                  "name": "KDI"
              },
              {
                  "id": "KDR",
                  "name": "KDR"
              },
              {
                  "id": "KOE",
                  "name": "KOE"
              },
              {
                  "id": "KRW",
                  "name": "KRW"
              },
              {
                  "id": "MDC",
                  "name": "MDC"
              },
              {
                  "id": "MDN",
                  "name": "MDN"
              },
              {
                  "id": "MES",
                  "name": "MES"
              },
              {
                  "id": "MGL",
                  "name": "MGL"
              },
              {
                  "id": "MJK",
                  "name": "MJK"
              },
              {
                  "id": "MKQ",
                  "name": "MKQ"
              },
              {
                  "id": "MXG",
                  "name": "MXG"
              },
              {
                  "id": "PBL",
                  "name": "PBL"
              },
              {
                  "id": "PDG",
                  "name": "PDG"
              },
              {
                  "id": "PGK",
                  "name": "PGK"
              },
              {
                  "id": "PKU",
                  "name": "PKU"
              },
              {
                  "id": "PKY",
                  "name": "PKY"
              },
              {
                  "id": "PLM",
                  "name": "PLM"
              },
              {
                  "id": "PLW",
                  "name": "PLW"
              },
              {
                  "id": "PNK",
                  "name": "PNK"
              },
              {
                  "id": "PSR",
                  "name": "PSR"
              },
              {
                  "id": "PWT",
                  "name": "PWT"
              },
              {
                  "id": "SDA",
                  "name": "SDA"
              },
              {
                  "id": "SMD",
                  "name": "SMD"
              },
              {
                  "id": "SMI",
                  "name": "SMI"
              },
              {
                  "id": "SOC",
                  "name": "SOC"
              },
              {
                  "id": "SOQ",
                  "name": "SOQ"
              },
              {
                  "id": "SRG",
                  "name": "SRG"
              },
              {
                  "id": "SUB",
                  "name": "SUB"
              },
              {
                  "id": "TGL",
                  "name": "TGL"
              },
              {
                  "id": "TGR",
                  "name": "TGR"
              },
              {
                  "id": "TIM",
                  "name": "TIM"
              },
              {
                  "id": "TJQ",
                  "name": "TJQ"
              },
              {
                  "id": "TKG",
                  "name": "TKG"
              },
              {
                  "id": "TNJ",
                  "name": "TNJ"
              },
              {
                  "id": "TRK",
                  "name": "TRK"
              },
              {
                  "id": "TSM",
                  "name": "TSM"
              },
              {
                  "id": "TTE",
                  "name": "TTE"
              },
              {
                  "id": "UPG",
                  "name": "UPG"
              },
              {
                  "id": "LBJ",
                  "name": "LBJ"
              },
              {
                  "id": "MKW",
                  "name": "MKW"
              }
          ],
          "branch_user_created": {
              "id": "ReFNB3fVg",
              "name": "CGK"
          },
          "cod_flag": "",
          "company_id": 230,
          "connote_batching_status": {
              "id": "",
              "name": ""
          },
          "connote_cancel": "",
          "created_at": 1727274985027,
          "created_by": 1922,
          "created_by_email": "bcmssuv.vika@jne.co.id",
          "customer_id": {
              "id": "",
              "name": ""
          },
          "customer_status": "",
          "customer_type": {
              "id": "",
              "name": ""
          },
          "customer_type_name": {
              "id": "",
              "name": ""
          },
          "destination_branch_id": {
              "id": "",
              "name": ""
          },
          "destination_urban_village_name": "",
          "econnote_flag": "",
          "filter_column_type": {
              "id": "ontQmVCIR",
              "name": "Cashless"
          },
          "flagging_stage": "General AWB Date",
          "id": "81bzxsRHRz",
          "ids": "81bzxsRHRz",
          "insurance_flag": "",
          "invoice_number": [],
          "invoice_number_cod": [],
          "length_batched": 0,
          "local_parent_id": "",
          "management_fee_id": "",
          "management_fee_name": "",
          "na_principal": {
              "id": "",
              "name": ""
          },
          "national_parent_id": "",
          "origin_branch_id": {
              "id": "",
              "name": ""
          },
          "origin_managing_entity_id": "",
          "origin_urban_village_name": "",
          "outbound_manifest_status": "",
          "payment_trf_date_ccnc_end": null,
          "payment_trf_date_ccnc_start": null,
          "pod_success_status": "",
          "pricing_detail_combination_id": "",
          "proforma_invoice_number": [],
          "progress_status": "0 %",
          "query_general": {
              "awb_date_end": 1727197200000,
              "awb_date_start": 1725123600000,
              "branch_id_multi": [
                  {
                      "id": "AMI",
                      "name": "AMI"
                  },
                  {
                      "id": "AMQ",
                      "name": "AMQ"
                  },
                  {
                      "id": "BDJ",
                      "name": "BDJ"
                  },
                  {
                      "id": "BDO",
                      "name": "BDO"
                  },
                  {
                      "id": "BKI",
                      "name": "BKI"
                  },
                  {
                      "id": "BKS",
                      "name": "BKS"
                  },
                  {
                      "id": "BOO",
                      "name": "BOO"
                  },
                  {
                      "id": "BPN",
                      "name": "BPN"
                  },
                  {
                      "id": "BTG",
                      "name": "BTG"
                  },
                  {
                      "id": "BTH",
                      "name": "BTH"
                  },
                  {
                      "id": "BTJ",
                      "name": "BTJ"
                  },
                  {
                      "id": "CBN",
                      "name": "CBN"
                  },
                  {
                      "id": "CGK",
                      "name": "CGK"
                  },
                  {
                      "id": "CKR",
                      "name": "CKR"
                  },
                  {
                      "id": "CLG",
                      "name": "CLG"
                  },
                  {
                      "id": "CXP",
                      "name": "CXP"
                  },
                  {
                      "id": "DJB",
                      "name": "DJB"
                  },
                  {
                      "id": "DJJ",
                      "name": "DJJ"
                  },
                  {
                      "id": "DPK",
                      "name": "DPK"
                  },
                  {
                      "id": "DPS",
                      "name": "DPS"
                  },
                  {
                      "id": "DTB",
                      "name": "DTB"
                  },
                  {
                      "id": "GTO",
                      "name": "GTO"
                  },
                  {
                      "id": "JBR",
                      "name": "JBR"
                  },
                  {
                      "id": "JOG",
                      "name": "JOG"
                  },
                  {
                      "id": "KDI",
                      "name": "KDI"
                  },
                  {
                      "id": "KDR",
                      "name": "KDR"
                  },
                  {
                      "id": "KOE",
                      "name": "KOE"
                  },
                  {
                      "id": "KRW",
                      "name": "KRW"
                  },
                  {
                      "id": "MDC",
                      "name": "MDC"
                  },
                  {
                      "id": "MDN",
                      "name": "MDN"
                  },
                  {
                      "id": "MES",
                      "name": "MES"
                  },
                  {
                      "id": "MGL",
                      "name": "MGL"
                  },
                  {
                      "id": "MJK",
                      "name": "MJK"
                  },
                  {
                      "id": "MKQ",
                      "name": "MKQ"
                  },
                  {
                      "id": "MXG",
                      "name": "MXG"
                  },
                  {
                      "id": "PBL",
                      "name": "PBL"
                  },
                  {
                      "id": "PDG",
                      "name": "PDG"
                  },
                  {
                      "id": "PGK",
                      "name": "PGK"
                  },
                  {
                      "id": "PKU",
                      "name": "PKU"
                  },
                  {
                      "id": "PKY",
                      "name": "PKY"
                  },
                  {
                      "id": "PLM",
                      "name": "PLM"
                  },
                  {
                      "id": "PLW",
                      "name": "PLW"
                  },
                  {
                      "id": "PNK",
                      "name": "PNK"
                  },
                  {
                      "id": "PSR",
                      "name": "PSR"
                  },
                  {
                      "id": "PWT",
                      "name": "PWT"
                  },
                  {
                      "id": "SDA",
                      "name": "SDA"
                  },
                  {
                      "id": "SMD",
                      "name": "SMD"
                  },
                  {
                      "id": "SMI",
                      "name": "SMI"
                  },
                  {
                      "id": "SOC",
                      "name": "SOC"
                  },
                  {
                      "id": "SOQ",
                      "name": "SOQ"
                  },
                  {
                      "id": "SRG",
                      "name": "SRG"
                  },
                  {
                      "id": "SUB",
                      "name": "SUB"
                  },
                  {
                      "id": "TGL",
                      "name": "TGL"
                  },
                  {
                      "id": "TGR",
                      "name": "TGR"
                  },
                  {
                      "id": "TIM",
                      "name": "TIM"
                  },
                  {
                      "id": "TJQ",
                      "name": "TJQ"
                  },
                  {
                      "id": "TKG",
                      "name": "TKG"
                  },
                  {
                      "id": "TNJ",
                      "name": "TNJ"
                  },
                  {
                      "id": "TRK",
                      "name": "TRK"
                  },
                  {
                      "id": "TSM",
                      "name": "TSM"
                  },
                  {
                      "id": "TTE",
                      "name": "TTE"
                  },
                  {
                      "id": "UPG",
                      "name": "UPG"
                  },
                  {
                      "id": "LBJ",
                      "name": "LBJ"
                  },
                  {
                      "id": "MKW",
                      "name": "MKW"
                  }
              ]
          },
          "query_khusus": {},
          "service_code": [],
          "status_connote": [],
          "status_export": "Ready to Generate",
          "status_report": "Processing",
          "total_connote_process": "19.628.293",
          "total_connote_process_number": 19628293,
          "total_paid_amount": 0,
          "updated_at": 1727275207361,
          "updated_by": 1922
      },
      "periodConnoteFrom": 1725123600000,
      "periodConnoteTo": 1727283599999,
      "total_connote": 19628293
  },
  "eachHours": {
      "end": 1725235199999,
      "endInText": "2-September-2024 6:59",
      "groupDedicated": 1,
      "index": 31,
      "locket": 31,
      "start": 1725231600000,
      "startInText": "2-September-2024 6:00"
  },
  "temporaryDateGenerateID": "-M6LbyRNR"
};

var counterLocket = payload.counterLocket;
var match = {};

var queryGeneral = payload.dataParameter.parameterCreate.query_general;

for (var key in queryGeneral) {
  if (queryGeneral.hasOwnProperty(key)) {
    if (key === "branch_id_multi" && Array.isArray(queryGeneral[key])) {
      match.branch_id = {
        $in: queryGeneral[key].map(function (branch) {
          return branch.name;
        }),
      };
    } else if (
      typeof queryGeneral[key] === "object" &&
      queryGeneral[key] !== null &&
      queryGeneral[key].id
    ) {
      match[key] = queryGeneral[key].id;
    } else if (
      key === "payment_trf_date_ccnc_start" ||
      key === "payment_trf_date_ccnc_end"
    ) {
      match.payment_trf_date_ccnc = match.payment_trf_date_ccnc || {};
      if (key === "payment_trf_date_ccnc_start") {
        match.payment_trf_date_ccnc.$gte = payload.eachHours.start;
      } else if (key === "payment_trf_date_ccnc_end") {
        match.payment_trf_date_ccnc.$lte = payload.eachHours.end;
      }
    } else if (key === "awb_date_start" || key === "awb_date_end") {
      match.awb_date = match.awb_date || {};
      if (key === "awb_date_start") {
        match.awb_date.$gte = payload.eachHours.start;
      } else if (key === "awb_date_end") {
        match.awb_date.$lte = payload.eachHours.end;
      }
    } else if (key === "status_connote" && Array.isArray(queryGeneral[key])) {
      match.status_connote = {
        $in: queryGeneral[key].map(function (status) {
          return status.name;
        }),
      };
    }
  }
}

var query = [
  {
    $match: match,
  },
  // {
  //   $project: columnHeader.columnGet,
  // },
  {
    $addFields: {
      // Convert number date to formatted string
      formatted_awb_date: {
        $cond: [
          { $eq: ["$awb_date", 0] },
          "--",
          {
            $dateToString: {
              format: "%d-%B-%y",
              date: { $toDate: "$awb_date" },
            },
          },
        ],
      },
      // Convert other number fields to string
      awb_number_string: { $concat: ["'", { $toString: "$awb_number" }] },
      part: { $literal: 0 }, // Add default part field
      id_export: {
        $concat: [
          { $toString: "$awb_number" },
          "-",
          payload.dataParameter.idParameter
        ],
      },
      grup_parent_id: { $literal: payload.dataParameter.idParameter },
    },
  },
];

console.log(query);